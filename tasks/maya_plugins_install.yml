---

- name: Get packages from xml
  loop: "{{ maya_packages }}"
  loop_control:
    loop_var: maya_package
  community.general.xml:
    path: "{{ maya_package_dir }}/{{ maya_package_sub_dir }}/pkg.{{ maya_package | lower }}.xml"
    xpath: "/_:Package/_:Configuration/_:InstallFile"
    content: attribute
    namespaces:
      _: "{{ xml_namespace }}"
  register: xml_result

- name: Build package mapping from xml results
  loop: "{{ xml_result.results }}"
  loop_control:
    label: "{{ item.maya_package }}"
  ansible.builtin.set_fact:
    maya_packages_map: >-
      {{
        maya_packages_map | default({})
        | combine({
            item.maya_package: item.matches[0]['{' ~ item.actions.namespaces._ ~ '}InstallFile']
          })
      }}

- name: Install maya plugin packages
  become: true
  loop: "{{ maya_packages_map | dict2items }}"
  loop_control:
    loop_var: maya_package
    label: "{{ maya_package.key }}"
  ansible.builtin.command:
    cmd: >-
      {{
        maya_install_cmds[maya_package.value.type]
        ~ (maya_package.value.type == 'RPM' and ' ' ~ (maya_package.value.installParams | default('')) or '')
        ~ ' '
        ~ maya_package.value.file
      }}
    chdir: "{{ maya_package_dir }}"
    creates: "{{ maya_modules_dir }}/{{ maya_package.key | lower }}.mod"
  register: plugin_install_result

- name: Rename Substance module
  when: '"Substance" in maya_packages and plugin_install_result.changed'
  block:
    - name: Rename substance module file
      become: true
      ansible.builtin.copy:
        remote_src: true
        src: "{{ maya_modules_dir }}/substance2.mod"
        dest: "{{ maya_modules_dir }}/substance.mod"
        mode: "0755"

    - name: Remove old substance module file
      become: true
      ansible.builtin.file:
        path: "{{ maya_modules_dir }}/substance2.mod"
        state: absent

...
